**Project 28：Ultrasonic Ranger**

1.  **Introduction**
    
    The HC-SR04 ultrasonic sensor is a very affordable distance sensor,
    which mainly used for obstacle avoidance in various robotic
    projects. It is also used for water level sensing and even as a
    parking sensor. In this project, we use a ESP32 to control an
    ultrasonic sensor and LEDs to simulate ultrasonic rangefinder.

2.  **Components**

<table>
<tbody>
<tr class="odd">
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Python/master/media/56053f7126905c6def63919c661d5c0a.jpeg" style="width:1.59722in;height:0.77986in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Python/master/media/e380dd26e4825be9a768973802a55fe6.png" style="width:0.75972in;height:1.8625in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Python/master/media/85df6831220dec7d43a68bfc9b7382cb.png" style="width:1.45764in;height:0.96319in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Python/master/media/7eb361d680dfa351f07f8527aeb37abd.png" style="width:0.275in;height:1.17361in" /></td>
<td></td>
</tr>
<tr class="even">
<td>ESP32*1</td>
<td>Breadboard*1</td>
<td>Ultrasonic Sensor*1</td>
<td>Red LED*4</td>
<td></td>
</tr>
<tr class="odd">
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Python/master/media/1fbdfe0569327d9a42600a54336bf7b5.png" style="width:1.38819in;height:1.15833in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Python/master/media/098a2730d0b0a2a4b2079e0fc87fd38b.png" style="width:1.22639in;height:0.49236in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Python/master/media/e9a8d050105397bb183512fb4ffdd2f6.png" style="width:0.90694in;height:0.90139in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5011-KS5011F-Keyestudio-ESP32-Learning-Kit-Complete-Edition-Python/master/media/7dcbd02995be3c142b2f97df7f7c03ce.png" style="width:0.99028in;height:0.52986in" /></td>
<td></td>
</tr>
<tr class="even">
<td>M-F Dupont Wires</td>
<td>220ΩResistor*4</td>
<td>Jumper Wires</td>
<td>USB Cable*1</td>
<td></td>
</tr>
</tbody>
</table>

3.  **Component Knowledge**

**HC-SR04 Ultrasonic Sensor :** Like bats, it uses sonar to determine
the distance to an object. It provides accurate non-contact range
detection, high-precision and stable readings. Its operation is not
affected by sunlight or black materials, just like a precision camera
(acoustically softer materials like cloth are difficult to detect). It
has an ultrasonic transmitter and a receiver.

![](/media/e6f6037071e434febf7090b56ac35802.png)

There are two metal cylinders in front of the ultrasonic sensor, which
are converters. The converters empower to convert the mechanical energy
into electrical signals. Furthermore, a transmitting converters and a
receiving converter are contained in the ultrasonic sensor. The
transmitting converter converts the electronic signals into an
ultrasonic pulse, and the receiving converter converts the reflected
ultrasonic pulse back to the electronic signals.

If you look at the back of the ultrasonic sensor, you will see an IC
behind the transmitting converter, which enables to control the
transmitting converter. There is also an IC behind the receiving
converter, which is a quad operational amplifier that amplifies the
signal generated by the receiving converter into a signal large enough
to be transmitted to the microcontroller.

**Sequence diagram**

The figure shows the sequence diagram of the HC-SR04. In order to start
the measurement, the trig of the SR04 must receive at least 10us high
pulse (5V), which will activate the sensor to emit 8 cycles of 40kHz
ultrasonic pulses, and wait for the reflected ultrasonic pulses.

When the sensor detects ultrasonic from the receiver, it will set the
Echo pin to high (5V) and delays it by one cycle (width), which is
proportional to the distance. We must measure the width of the Echo pin
if we are to get the distance.

![](/media/4114885ac4b6214953e3224d8c1d52c4.png)

Time = Echo pulse width, its unit is “us” (microseconds)

Distance in centimeters = time / 58

Distance in inches = time / 148

4.  **Read the ultrasonic sensor**
    
    We will start with a simple ultrasonic ranging and print the
    measured distance.
    
    ![](/media/db430baa07e2e4d9ac9efca1950b953a.jpeg)
    
    The HC-SR04 ultrasonic sensor has four pins, which are Vcc, Trig,
    Echo and GND. The Vcc pin provides the power for generating
    ultrasonic pulses and is connected to Vcc (+5V). The GND pin is
    grounded.
    
    The Trig pin is where the control board sends a signal to start the
    ultrasonic pulse. The Echo pin is where the ultrasonic sensor sends
    information about the duration of the ultrasonic pulse to the the
    control board.

![](/media/a8d408be3629a2d288dbb30bd60007af.png)

The code used in this tutorial is saved in“4. Python Tutorial\\2. Python
Projects”. You can move the codes to any location. For example, we save
the codes in Disk(D) with the path of “D:\\2. Python Projects”.

![](/media/906b7d4391131929a6b0726f7f5bab30.png)

Open“Thonny”，click“This computer”→“D:”→“2. Python Projects”→“Project
28：Ultrasonic Ranger”，and double left-click
“Project\_28.1\_Ultrasonic\_Ranging.py”.

![](/media/e6c25c5a8e84241549192cdcb1a7fa57.png)

<table>
<tbody>
<tr class="odd">
<td><p>from machine import Pin</p>
<p>import time</p>
<p>#Define the control pins of the ultrasonic ranging module.</p>
<p>Trig = Pin(13, Pin.OUT, 0)</p>
<p>Echo = Pin(14, Pin.IN, 0)</p>
<p>distance = 0 # Define the initial distance to be 0.</p>
<p>soundVelocity = 340 #Set the speed of sound.</p>
<p># The getDistance() function is used to drive the ultrasonic module to measure distance,</p>
<p># the Trig pin keeps at high level for 10us to start the ultrasonic module.</p>
<p># Echo.value() is used to read the status of ultrasonic module’s Echo pin,</p>
<p># and then use timestamp function of the time module to calculate the duration of Echo</p>
<p># pin’s high level,calculate the measured distance based on time and return the value.</p>
<p>def getDistance():</p>
<p>Trig.value(1)</p>
<p>time.sleep_us(10)</p>
<p>Trig.value(0)</p>
<p>while not Echo.value():</p>
<p>pass</p>
<p>pingStart = time.ticks_us()</p>
<p>while Echo.value():</p>
<p>pass</p>
<p>pingStop = time.ticks_us()</p>
<p>pingTime = time.ticks_diff(pingStop, pingStart) // 2</p>
<p>distance = int(soundVelocity * pingTime // 10000)</p>
<p>return distance</p>
<p># Delay for 2 seconds and wait for the ultrasonic module to stabilize,</p>
<p># Print data obtained from ultrasonic module every 500 milliseconds.</p>
<p>time.sleep(2)</p>
<p>while True:</p>
<p>time.sleep_ms(500)</p>
<p>distance = getDistance()</p>
<p>print("Distance: ", distance, "cm")</p></td>
</tr>
</tbody>
</table>

Make sure the ESP32 has been connected to the computer, then
click![](/media/27451c8a9c13e29d02bc0f5831cfaf1f.png)“Stop/Restart backend” .

![](/media/de050179402eca877c57b6c13efc9a48.png)

Click![](/media/da852227207616ccd9aff28f19e02690.png)“Run current script”, the code starts to be
executed and you'll see that the "Shell" window of Thonny IDE will print
the distance between the ultrasonic sensor and the object.
Press“Ctrl+C”or click![](/media/27451c8a9c13e29d02bc0f5831cfaf1f.png)“Stop/Restart backend”to
exit the program.

![](/media/12c139edce8d5cbbbd263263ce29cf1b.png)

![](/media/ce873cf513307a15f9aa58078c8dd7d6.png)

5.  **Wiring diagram of the ultrasonic rangefinder**
    
    Next, we will use a ESP32 to control an ultrasonic sensor and 4 LEDs
    to simulate ultrasonic rangefinder.
    
    ![](/media/910ed1be8be94411a090afb95af86d1a.png)

6.  **Test Code**

The code used in this tutorial is saved in“4. Python Tutorial\\2. Python
Projects”. You can move the codes to any location. For example, we save
the codes in Disk(D) with the path of “D:\\2. Python Projects”.

![](/media/906b7d4391131929a6b0726f7f5bab30.png)

Open“Thonny”，click“This computer”→“D:”→“2. Python Projects”→“Project
28：Ultrasonic Ranger”，and double left-click
“Project\_28.2\_Ultrasonic\_Ranger.py”.

![](/media/71f0a75a1d5bf96b8070d436d8f0d965.png)

<table>
<tbody>
<tr class="odd">
<td><p>from machine import Pin</p>
<p>import time</p>
<p>#Define the pins of four leds.</p>
<p>led1 = Pin(4, Pin.OUT)</p>
<p>led2 = Pin(0, Pin.OUT)</p>
<p>led3 = Pin(2, Pin.OUT)</p>
<p>led4 = Pin(15, Pin.OUT)</p>
<p># Define the control pins of the ultrasonic ranging module.</p>
<p>Trig = Pin(13, Pin.OUT, 0)</p>
<p>Echo = Pin(14, Pin.IN, 0)</p>
<p>distance = 0 # Define the initial distance to be 0.</p>
<p>soundVelocity = 340 #Set the speed of sound.</p>
<p># The getDistance() function is used to drive the ultrasonic module to measure distance,</p>
<p># the Trig pin keeps at high level for 10us to start the ultrasonic module.</p>
<p># Echo.value() is used to read the status of ultrasonic module’s Echo pin,</p>
<p># and then use timestamp function of the time module to calculate the duration of Echo</p>
<p># pin’s high level,calculate the measured distance based on time and return the value.</p>
<p>def getDistance():</p>
<p>Trig.value(1)</p>
<p>time.sleep_us(10)</p>
<p>Trig.value(0)</p>
<p>while not Echo.value():</p>
<p>pass</p>
<p>pingStart = time.ticks_us()</p>
<p>while Echo.value():</p>
<p>pass</p>
<p>pingStop = time.ticks_us()</p>
<p>pingTime = time.ticks_diff(pingStop, pingStart) // 2</p>
<p>distance = int(soundVelocity * pingTime // 10000)</p>
<p>return distance</p>
<p># Delay for 2 seconds and wait for the ultrasonic module to stabilize,</p>
<p># Print data obtained from ultrasonic module every 500 milliseconds.</p>
<p>time.sleep(2)</p>
<p>while True:</p>
<p>time.sleep_ms(500)</p>
<p>distance = getDistance()</p>
<p>print("Distance: ", distance, "cm")</p>
<p>if distance &lt;= 5:</p>
<p>led1.value(1)</p>
<p>else:</p>
<p>led1.value(0)</p>
<p>if distance &lt;= 10:</p>
<p>led2.value(1)</p>
<p>else:</p>
<p>led2.value(0)</p>
<p>if distance &lt;= 15:</p>
<p>led3.value(1)</p>
<p>else:</p>
<p>led3.value(0)</p>
<p>if distance &lt;= 20:</p>
<p>led4.value(1)</p>
<p>else:</p>
<p>led4.value(0)</p></td>
</tr>
</tbody>
</table>

7.  **Test Result**

Make sure the ESP32 has been connected to the computer, then
click![](/media/27451c8a9c13e29d02bc0f5831cfaf1f.png)“Stop/Restart backend” .

![](/media/087ac41130cad1d184e0e7f8df8f7303.png)

Click![](/media/da852227207616ccd9aff28f19e02690.png)“Run current script”, the code starts to be
executed and you'll see that the "Shell" window of Thonny IDE will print
the distance between the ultrasonic sensor and the object, and the
corresponding LED will light up when we move our hand in front of the
ultrasonic sensor. Press“Ctrl+C”or
click![](/media/27451c8a9c13e29d02bc0f5831cfaf1f.png)“Stop/Restart backend”to exit the program.

![](/media/c9d8a285a495c374199bf41061e061ab.png)
